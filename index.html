<!-- Firebase Voting Application Using GitHub, HTML, and Firebase -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사내 학술 포스터 투표</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loginSection">
        <h1>로그인</h1>
        <label for="employeeId">사번:</label>
        <input type="text" id="employeeId" required>
        <br>
        <label for="password">비밀번호:</label>
        <input type="password" id="password" required>
        <br>
        <button id="loginButton">로그인</button>
        <p id="loginError" style="color:red;"></p>
    </div>

    <div id="voteSection" style="display:none;">
        <h1>포스터 투표</h1>
        <p>최대 3개의 포스터에 투표할 수 있습니다.</p>
        <button id="voteStart">투표하기</button>
        <div id="posterSelection" style="display:none;">
            <form id="voteForm">
                <div id="posterList">
                    <!-- 포스터 목록이 여기 생성됩니다 -->
                </div>
                <button type="submit">투표 완료</button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK 추가 (compat 버전 사용) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script>
        // Firebase 설정 정보
        const firebaseConfig = {
        apiKey: "AIzaSyDwuJWSpcyJC-70weCp--AiZn5-NQDssts",
        authDomain: "test-3241f.firebaseapp.com",
        projectId: "test-3241f",
        storageBucket: "test-3241f.appspot.com",
        messagingSenderId: "879797966506",
        appId: "1:879797966506:web:dfa57f8d49269cb43d22d3",
        measurementId: "G-6MDWTLHN6G"
        };
        
        // Firebase 초기화
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // DOMContentLoaded 이벤트 리스너 추가
        document.addEventListener("DOMContentLoaded", function() {
            // 하드코딩된 로그인 정보 (사번 및 주민등록번호 앞 6자리)
            const validUsers = [
                { employeeId: '106855', password: '970301' },
                { employeeId: '204678', password: '960412' },
                { employeeId: '309123', password: '951223' }
            ];

            // 로그인 버튼 클릭 이벤트
            document.getElementById('loginButton').addEventListener('click', function() {
                const employeeId = document.getElementById('employeeId').value;
                const password = document.getElementById('password').value;
                const loginError = document.getElementById('loginError');

                // 로그인 검증
                const isValidUser = validUsers.some(user => user.employeeId === employeeId && user.password === password);

                if (isValidUser) {
                    // 로그인 성공
                    loginError.textContent = '';
                    document.getElementById('loginSection').style.display = 'none'; // 로그인 섹션 숨기기
                    document.getElementById('voteSection').style.display = 'block'; // 투표 섹션 보이기
                } else {
                    // 로그인 실패
                    loginError.textContent = '사번 또는 비밀번호가 올바르지 않습니다.';
                }
            });

            // "투표하기" 버튼 클릭 이벤트
            document.getElementById('voteStart').addEventListener('click', function() {
                // "투표하기" 버튼을 누르면 포스터 선택 화면을 보여줌
                document.getElementById('posterSelection').style.display = 'block';
                generatePosterList();
            });

            // 투표 완료 버튼 클릭 시
            document.getElementById('voteForm').addEventListener('submit', function(event) {
                event.preventDefault();
                
                const checkedBoxes = document.querySelectorAll('input[type="checkbox"]:checked');
                const maxVotes = 3; // 최대 투표 가능 수

                if (checkedBoxes.length > maxVotes) {
                    alert(`최대 ${maxVotes}개의 포스터만 선택할 수 있습니다.`);
                    return;
                }

                const selectedPosters = Array.from(checkedBoxes).map(cb => cb.value);
                console.log('선택된 포스터:', selectedPosters);

                // Firebase에 저장
                saveToFirebase(selectedPosters);
            });
        });

        // 포스터 리스트 생성 함수
        function generatePosterList() {
            const posterList = document.getElementById('posterList');
            const maxVotes = 3;
            const posters = 32;  // 포스터 개수

            // 기존 목록 삭제 (중복 방지)
            posterList.innerHTML = '';

            // 포스터 리스트 생성
            for (let i = 1; i <= posters; i++) {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = 'poster' + i;
                checkbox.value = i;

                const label = document.createElement('label');
                label.htmlFor = 'poster' + i;
                label.innerText = '포스터 ' + i;

                const br = document.createElement('br');
                posterList.appendChild(checkbox);
                posterList.appendChild(label);
                posterList.appendChild(br);
            }
        }

        // Firebase에 투표 결과 저장하는 함수
        async function saveToFirebase(selectedPosters) {
            try {
                const voteData = {
                    posters: selectedPosters,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection("votes").add(voteData);
                alert('투표가 완료되었습니다!');
                window.location.href = 'index.html'; // 투표 후 로그아웃
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                alert('투표 저장 중 오류가 발생했습니다.');
            }
        }
    </script>
</body>
</html>
